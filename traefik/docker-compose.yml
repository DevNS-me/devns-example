# ============================================================================
# Traefik Reverse Proxy - Routes traffic to projects by domain name
# ============================================================================
# Copy .env.template to .env and configure certificate URLs for HTTPS (optional)
# Dashboard: http://localhost:8080
# ============================================================================

name: traefik

networks:
  proxy:
    name: ${PROXY_NETWORK}

services:
  traefik:
    image: traefik:v3.6
    command:
      #- --accesslog=true  # Uncomment to enable access logs
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.network=${PROXY_NETWORK}
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --providers.file.filename=/etc/traefik/tls.yml
      # Header forwarding for proxies like ngrok
      - --entrypoints.web.proxyProtocol.insecure=true
      - --entrypoints.web.forwardedHeaders.insecure=true
    ports:
      - 80:80      # HTTP
      - 443:443    # HTTPS
      - 8080:8080  # Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./.docker/traefik:/etc/traefik
      - certs:/etc/ssl/traefik
    networks:
      - proxy
    restart: unless-stopped

  # Auto-downloads and configures HTTPS certificates from DevNS.me
  traefik-https-helper:
    image: alpine
    command: sh /scripts/setup-certs.sh
    env_file:
      - .env
    volumes:
      - certs:/etc/ssl/traefik
      - ./.docker/traefik:/etc/traefik
      - ./.docker/traefik/setup-certs.sh:/scripts/setup-certs.sh:ro

volumes:
  certs:
